# Spec: Version Control

## 新增需求

### 需求：操作记录

系统 **必须** 记录每次 AI 对文档的修改操作。

#### 场景：操作捕获

- **当** AI 执行任何文档修改操作
- **那么** 系统 **必须** 自动记录操作类型、参数、时间戳和 AI 原始指令

#### 场景：操作链表

- **当** 记录操作时
- **那么** 系统 **必须** 维护操作的父子关系，形成完整的操作链

---

### 需求：版本管理

系统 **必须** 将操作组织为版本并提供版本切换功能。

#### 场景：版本创建

- **当** 用户完成一组相关操作或手动创建检查点
- **那么** 系统 **必须** 创建新版本并关联所有操作

#### 场景：版本切换

- **当** 用户请求切换到指定版本
- **那么** 系统 **必须** 加载该版本的文档状态并设为当前工作版本

#### 场景：版本列表

- **当** 用户打开历史面板
- **那么** 系统 **必须** 显示所有版本的列表，包括时间、描述、分支信息

---

### 需求：分支管理

系统 **必须** 支持 Git 风格的分支创建和切换。

#### 场景：分支创建

- **当** 用户请求创建新分支
- **那么** 系统 **必须** 从当前版本创建分支副本，允许独立演化

#### 场景：分支切换

- **当** 用户请求切换到指定分支
- **那么** 系统 **必须** 加载该分支 HEAD 版本的文档状态

#### 场景：分支列表

- **当** 用户查看所有分支
- **那么** 系统 **必须** 显示每个分支的名称、HEAD 版本、创建时间

---

### 需求：历史持久化

系统 **必须** 将操作历史持久化到磁盘，确保应用重启后可恢复。

#### 场景：历史保存

- **当** 每次操作完成
- **那么** 系统 **必须** 立即将操作元数据写入 SQLite 数据库

#### 场景：历史恢复

- **当** 应用启动
- **那么** 系统 **必须** 加载历史数据库并恢复上次会话的状态

#### 场景：数据完整性

- **当** 写入历史数据
- **那么** 系统 **必须** 使用事务确保数据完整性，失败时回滚

---

### 需求：快照管理

系统 **必须** 定期创建完整文档快照以优化版本恢复性能。

#### 场景：自动快照

- **当** 累积操作数达到阈值（如每 10 次操作）
- **那么** 系统 **必须** 自动创建当前文档状态的完整快照

#### 场景：手动快照

- **当** 用户请求创建快照
- **那么** 系统 **必须** 立即保存当前文档完整状态

#### 场景：快照加载

- **当** 用户切换到无快照的旧版本
- **那么** 系统 **必须** 找到最近快照并重放后续操作以恢复目标版本

---

### 需求：撤销和重做

系统 **必须** 支持单步撤销和重做操作。

#### 场景：单步撤销

- **当** 用户按 Ctrl+Z
- **那么** 系统 **必须** 撤销最后一次操作并恢复到前一状态

#### 场景：单步重做

- **当** 用户按 Ctrl+Shift+Z
- **那么** 系统 **必须** 重做之前撤销的操作

#### 场景：撤销限制

- **当** 用户连续撤销到达历史起点
- **那么** 系统 **必须** 禁用撤销功能并提示用户

---

### 需求：版本对比

系统 **必须** 支持比较两个版本之间的差异。

#### 场景：版本选择对比

- **当** 用户选择两个版本进行对比
- **那么** 系统 **必须** 计算并显示两个版本间的操作差异

#### 场景：差异可视化

- **当** 系统显示版本差异
- **那么** 系统 **必须** 使用颜色和标记清晰显示新增、删除、修改的内容

---

### 需求：历史清理

系统 **必须** 自动清理过期历史以防止存储空间膨胀。

#### 场景：过期历史删除

- **当** 历史记录超过保留期限（如 30 天）
- **那么** 系统 **必须** 自动删除过期版本和相关操作记录

#### 场景：孤立快照清理

- **当** 执行历史清理
- **那么** 系统 **必须** 同时删除不再被任何版本引用的快照文件

---

### 需求：性能优化

系统 **必须** 优化历史操作性能以避免影响编辑体验。

#### 场景：增量存储

- **当** 保存操作变更
- **那么** 系统 **必须** 只存储增量数据而非完整文档副本

#### 场景：数据压缩

- **当** 操作变更数据超过 1KB
- **那么** 系统 **必须** 使用压缩算法存储以节省磁盘空间

#### 场景：懒加载历史

- **当** 用户查看历史时间线
- **那么** 系统 **必须** 只加载可见范围的历史记录，滚动时按需加载

---

### 需求：并发控制

系统 **必须** 处理并发编辑场景下的历史一致性。

#### 场景：操作排队

- **当** 系统同时接收多个操作请求
- **那么** 系统 **必须** 按顺序排队处理，确保历史链完整

#### 场景：冲突检测

- **当** 检测到可能的历史冲突（如外部修改文档）
- **那么** 系统 **必须** 警告用户并建议重新加载或创建分支
